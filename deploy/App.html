<!DOCTYPE html>
<html>
<head>
    <title>Random App Name64611</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",comboboxConfig:{fieldLabel:"Select an release:</div>",width:400},componentCls:"app",onScopeChange:function(timeboxscope){var release=timeboxscope.getRecord(),timeboxstore=Ext.create("Rally.data.wsapi.Store",{model:"Release",filters:[{property:"Name",operator:"=",value:release.get("Name")}],context:this.getContext().getDataContext(),fetch:["ObjectID"],autoload:!1});timeboxstore.load().then({success:function(releases){for(var relScopeOIDs=this._getReleaseScopeOIDs(releases),snapshotdates=this._getSnapshotdates(this.getContext().getTimeboxScope().getRecord()),loadfunctions=[],i=0;snapshotdates.length>i;i++){var snapshotStore=this._createRelSnapshotStoreAtDate(relScopeOIDs,snapshotdates[i]);loadfunctions.push(snapshotStore.load())}Deft.Promise.all(loadfunctions).then({success:function(results){var gridrecords=this._buildDisplayGridRecords(results);this._displayxgrid(gridrecords)},failure:function(){},scope:this})},failure:function(){},scope:this})},_getReleaseScopeOIDs:function(releases){var oids=[];return _.each(releases,function(release){oids.push(release.get("ObjectID"))}),oids},_getSnapshotdates:function(release){var atDates=[];atDates.push(release.get("formattedStartDate"));for(var dstart=new Date(release.get("formattedStartDate")),dend=new Date(release.get("formattedEndDate")),dnow=new Date,dnext=Rally.util.DateTime.add(dstart,"day",14);Rally.util.DateTime.getDifference(dend,dnext,"day")>0&&Rally.util.DateTime.getDifference(dnow,dnext,"day")>0;)atDates.push(Rally.util.DateTime.format(dnext,"Y-m-d")),dnext=Rally.util.DateTime.add(dnext,"day",14);return Rally.util.DateTime.getDifference(dnow,dend,"day")>0?atDates.push(release.get("formattedEndDate")):atDates.push("current"),atDates},_createRelSnapshotStoreAtDate:function(relScopeOIDs,atDate){var snapshotfilters=[];return snapshotfilters.push({property:"_ProjectHierarchy",value:this.getContext().getProject().ObjectID}),snapshotfilters.push({property:"_TypeHierarchy",value:"PortfolioItem/Feature"}),snapshotfilters.push({property:"Release",operator:"$in",value:relScopeOIDs}),snapshotfilters.push({id:"__At",property:"__At",value:atDate}),Ext.create("Rally.data.lookback.SnapshotStore",{compress:!0,context:this.getContext().getDataContext(),fetch:["FormattedID","Name","c_ServiceNowID","Release","Project","LeafStoryCount","LeafStoryPlanEstimateTotal"],hydrate:["Project"],sorters:[{property:"FormattedID",direction:"ASC"}],filters:snapshotfilters,removeUnauthorizedSnapshots:!0})},_buildDisplayGridRecords:function(loadresults){console.log(loadresults);for(var snapshotdates=this._getSnapshotdates(this.getContext().getTimeboxScope().getRecord()),gridrecords=[],i=0;loadresults.length>i;i++){var count,added,removed,changed,unchanged=0,store=loadresults[i][0].store,atDate=store.getFilters().items[3].value;count=loadresults[i].length;for(var n=0;loadresults[i].length>n;n++){var snapshot=loadresults[i][n],gricrec=gridrecords.find(function(element){return element.FormattedID===snapshot.get("FormattedID")});if(void 0===gricrec){var newgridrec={};newgridrec.FormattedID=snapshot.get("FormattedID"),newgridrec.Name=snapshot.get("Name"),newgridrec.Demand=snapshot.get("c_ServiceNowID"),newgridrec.Project=snapshot.get("Project").Name;for(var j=0;snapshotdates.length>j;j++)newgridrec[snapshotdates[j]]=null;newgridrec[atDate]=snapshot.get("LeafStoryPlanEstimateTotal"),newgridrec.firstVal=snapshot.get("LeafStoryPlanEstimateTotal"),newgridrec.planEstDiff=0,gridrecords.push(newgridrec),i>0&&added++}else gricrec[atDate]=snapshot.get("LeafStoryPlanEstimateTotal"),gricrec.planEstDiff=snapshot.get("LeafStoryPlanEstimateTotal")-gricrec.firstVal,0!==gricrec.planEstDiff&&changed++;if(i>0)var prevcount=loadresults[i-1].length,currcount=loadresults[i].length,removed=currcount-prevcount-added}}for(i=0;gridrecords.length>i;i++){var gridrec=gridrecords[i];gridrec.Note=null===gridrec[snapshotdates[0]]?"added":null===gridrec[snapshotdates[snapshotdates.length-1]]?"removed":0!==gridrec.planEstDiff?"changed":"unchanged"}return console.log(gridrecords),gridrecords},_displayxgrid:function(gridrecords){this._myGrid&&this._myGrid.destroy();for(var columns=[{text:"ID",dataIndex:"FormattedID"},{text:"Name",dataIndex:"Name",width:400},{text:"Demand",dataIndex:"Demand",width:150},{text:"Project",dataIndex:"Project",width:150}],snapshotdates=this._getSnapshotdates(this.getContext().getTimeboxScope().getRecord()),i=0;snapshotdates.length>i;i++)columns.push({text:snapshotdates[i],dataIndex:snapshotdates[i],summaryType:"sum"});columns.push({text:"Plan Est Total Chg",dataIndex:"planEstDiff",summaryType:"sum"}),columns.push({text:"Note",dataIndex:"Note"}),this._myGrid=Ext.create("Rally.ui.grid.Grid",{xtype:"rallygridboard",showRowActionsColumn:!1,store:Ext.create("Rally.data.custom.Store",{data:gridrecords,sorters:[{property:"planEstDiff",direction:"DESC"}]}),columnCfgs:columns,title:"Release features Plan estimate total changes over time",features:[{ftype:"summary"}]}),this.add(this._myGrid)},_createSumGricRecs:function(dates){for(var sumrecs=[],counters=["added","removed","changed","unchanged","count"],c=0;counters.length>c;c++){var newrec={};newrec.label=counters[c];for(var d=0;dates.length>d;d++)newrec[dates[d]]=0;counters.push(newrec)}return records}});

            Rally.launchApp('CustomApp', {
                name:"Random App Name64611",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
